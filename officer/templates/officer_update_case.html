{% extends 'base_officer.html' %}

{% block title %}Update Case | Officer Portal{% endblock %}

{% block page_title %}Update Case{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Original Case Details -->
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Original Case Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th style="width: 150px;">Case Number:</th>
                                    <td>{{ case.case_number }}</td>
                                </tr>
                                <tr>
                                    <th>Missing Person:</th>
                                    <td>{{ case.get_full_name }}</td>
                                </tr>
                                <tr>
                                    <th>Age:</th>
                                    <td>{{ case.age }} years</td>
                                </tr>
                                <tr>
                                    <th>Gender:</th>
                                    <td>{{ case.get_gender_display }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th style="width: 150px;">Last Seen:</th>
                                    <td>{{ case.last_seen_date|date:"F d, Y" }}</td>
                                </tr>
                                <tr>
                                    <th>Location:</th>
                                    <td>{{ case.last_seen_location }}</td>
                                </tr>
                                <tr>
                                    <th>Current Status:</th>
                                    <td>
                                        <span class="badge {% if case.status == 'found' %}bg-success{% elif case.status == 'pending' %}bg-warning{% elif case.status == 'under_investigation' %}bg-info{% else %}bg-secondary{% endif %}">
                                            {{ case.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Reported On:</th>
                                    <td>{{ case.created_at|date:"F d, Y" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Update Form -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Update Case</h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Status and Priority -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="status" class="form-label">Case Status</label>
                                    <select class="form-select" id="status" name="status" required>
                                        <option value="pending" {% if case.status == 'pending' %}selected{% endif %}>Pending</option>
                                        <option value="under_investigation" {% if case.status == 'under_investigation' %}selected{% endif %}>Under Investigation</option>
                                        <option value="found" {% if case.status == 'found' %}selected{% endif %}>Found</option>
                                        <option value="closed" {% if case.status == 'closed' %}selected{% endif %}>Closed</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="priority" class="form-label">Priority Level</label>
                                    <select class="form-select" id="priority" name="priority" required>
                                        <option value="low" {% if case.priority == 'low' %}selected{% endif %}>Low</option>
                                        <option value="medium" {% if case.priority == 'medium' %}selected{% endif %}>Medium</option>
                                        <option value="high" {% if case.priority == 'high' %}selected{% endif %}>High</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Update Description -->
                        <div class="form-group mb-4">
                            <label for="update_description" class="form-label">Update Description</label>
                            <textarea class="form-control" id="update_description" name="update_description" rows="3" required></textarea>
                            <small class="text-muted">Describe the latest updates or findings in the case</small>
                        </div>

                        <!-- Evidence Document (Required for closing) -->
                        <div class="form-group mb-4" id="evidenceSection" style="display: none;">
                            <label for="evidence_document" class="form-label">Evidence Document <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="evidence_document" name="evidence_document">
                            <small class="text-muted">Upload evidence document (required when closing the case)</small>
                        </div>

                        <!-- Notes Section -->
                        <div class="form-group mb-4">
                            <label for="notes" class="form-label">Investigation Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3">{{ case.notes }}</textarea>
                            <small class="text-muted">Add any additional notes or updates about the case</small>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'officer_view_case' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Case
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Show/hide evidence document section based on status
    document.getElementById('status').addEventListener('change', function() {
        const evidenceSection = document.getElementById('evidenceSection');
        const evidenceDocument = document.getElementById('evidence_document');
        
        if (this.value === 'closed') {
            evidenceSection.style.display = 'block';
            evidenceDocument.required = true;
        } else {
            evidenceSection.style.display = 'none';
            evidenceDocument.required = false;
        }
    });

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const status = document.getElementById('status').value;
        const evidenceDocument = document.getElementById('evidence_document');
        
        if (status === 'closed' && !evidenceDocument.files.length) {
            e.preventDefault();
            alert('Evidence document is required when closing a case.');
            return;
        }

        const requiredFields = this.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields');
        }
    });
</script>
{% endblock %}

{% endblock %}


